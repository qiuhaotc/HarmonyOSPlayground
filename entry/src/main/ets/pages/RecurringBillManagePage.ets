import { RecurringBillConfig, RecurringType } from '../models/RecurringBillModel';
import { BillType } from '../models/BillModel';
import { RecurringBillDatabase } from '../database/RecurringBillDatabase';
import { BillDatabase } from '../database/BillDatabase';
import router from '@ohos.router';

/**
 * å®šæœŸè®°è´¦ç®¡ç†é¡µé¢
 */
@Entry
@Component
struct RecurringBillManagePage {
  @State configs: RecurringBillConfig[] = [];
  @State loading: boolean = false;
  private recurringDb: RecurringBillDatabase = RecurringBillDatabase.getInstance();

  async aboutToAppear() {
    // åˆå§‹åŒ–æ•°æ®åº“
    try {
      await this.recurringDb.init(getContext(this));
    } catch (err) {
      console.error('åˆå§‹åŒ–å®šæœŸè®°è´¦æ•°æ®åº“å¤±è´¥', JSON.stringify(err));
    }

    // åŠ è½½é…ç½®åˆ—è¡¨
    await this.loadConfigs();
  }

  // åŠ è½½é…ç½®åˆ—è¡¨
  async loadConfigs() {
    this.loading = true;
    try {
      this.configs = await this.recurringDb.queryAllConfigs();
    } catch (err) {
      console.error('åŠ è½½å®šæœŸé…ç½®å¤±è´¥', JSON.stringify(err));
      this.getUIContext().getPromptAction().showToast({
        message: "åŠ è½½å¤±è´¥",
        duration: 1000
      });
    }
    this.loading = false;
  }

  build() {
    Column() {
      // æ ‡é¢˜æ 
      this.buildTitleBar();

      if (this.loading) {
        // åŠ è½½ä¸­
        Column() {
          LoadingProgress()
            .width(48)
            .height(48)
            .color($r('app.color.primary_color'))
        }
        .width('100%')
        .height('100%')
        .justifyContent(FlexAlign.Center)
      } else if (this.configs.length === 0) {
        // ç©ºçŠ¶æ€
        Column() {
          Text('ğŸ“…')
            .fontSize(64)
            .margin({ bottom: 16 })

          Text('æš‚æ— å®šæœŸè®°è´¦é…ç½®')
            .fontSize(16)
            .fontColor($r('app.color.text_tertiary'))
            .margin({ bottom: 8 })

          Text('ç‚¹å‡»å³ä¸Šè§’"æ·»åŠ "åˆ›å»ºå®šæœŸè®°è´¦')
            .fontSize(14)
            .fontColor($r('app.color.text_tertiary'))
        }
        .width('100%')
        .layoutWeight(1)
        .justifyContent(FlexAlign.Center)
      } else {
        // é…ç½®åˆ—è¡¨
        List({ space: 1 }) {
          ForEach(this.configs, (config: RecurringBillConfig) => {
            ListItem() {
              this.buildConfigItem(config);
            }
          })
        }
        .width('100%')
        .layoutWeight(1)
        .backgroundColor($r('app.color.page_background'))
      }
    }
    .width('100%')
    .height('100%')
    .backgroundColor($r('app.color.page_background'))
  }

  @Builder
  buildTitleBar() {
    Row() {
      Text('è¿”å›')
        .fontSize(16)
        .fontColor($r('app.color.text_primary'))
        .onClick(() => {
          router.back();
        })

      Text('å®šæœŸè®°è´¦')
        .fontSize(18)
        .fontWeight(FontWeight.Bold)
        .fontColor($r('app.color.text_primary'))
        .layoutWeight(1)
        .textAlign(TextAlign.Center)

      Text('æ·»åŠ ')
        .fontSize(16)
        .fontColor($r('app.color.primary_color'))
        .onClick(() => {
          router.pushUrl({ url: 'pages/AddBillPage' });
        })
    }
    .width('100%')
    .height(56)
    .padding({ left: 16, right: 16 })
    .backgroundColor($r('app.color.card_background'))
  }

  @Builder
  buildConfigItem(config: RecurringBillConfig) {
    Row() {
      Column() {
        // é‡‘é¢å’Œåˆ†ç±»
        Row() {
          Text(config.type === BillType.EXPENSE ? '-' : '+')
            .fontSize(24)
            .fontWeight(FontWeight.Bold)
            .fontColor(config.type === BillType.EXPENSE ? $r('app.color.danger_color') : $r('app.color.success_color'))

          Text(`Â¥${config.amount.toFixed(2)}`)
            .fontSize(24)
            .fontWeight(FontWeight.Bold)
            .fontColor(config.type === BillType.EXPENSE ? $r('app.color.danger_color') : $r('app.color.success_color'))
            .margin({ left: 4 })

          Text(config.category)
            .fontSize(14)
            .fontColor($r('app.color.text_tertiary'))
            .margin({ left: 12 })
        }
        .width('100%')
        .margin({ bottom: 8 })

        // é‡å¤è§„åˆ™
        Text(`${config.getRecurringTypeText()} â€¢ ${config.getEndConditionText()}`)
          .fontSize(14)
          .fontColor($r('app.color.text_secondary'))
          .margin({ bottom: 4 })

        // å¼€å§‹æ—¥æœŸå’ŒçŠ¶æ€
        Row() {
          Text(`å¼€å§‹: ${config.startDate}`)
            .fontSize(12)
            .fontColor($r('app.color.text_tertiary'))

          Text(config.isActive ? 'å¯ç”¨ä¸­' : 'å·²åœç”¨')
            .fontSize(12)
            .fontColor(config.isActive ? $r('app.color.success_color') : $r('app.color.text_tertiary'))
            .padding({ left: 8, right: 8, top: 2, bottom: 2 })
            .backgroundColor(config.isActive ? '#E8F5E9' : $r('app.color.page_background'))
            .borderRadius(4)
            .margin({ left: 12 })
        }

        // å¤‡æ³¨
        if (config.note) {
          Text(config.note)
            .fontSize(12)
            .fontColor($r('app.color.text_tertiary'))
            .maxLines(1)
            .textOverflow({ overflow: TextOverflow.Ellipsis })
            .margin({ top: 4 })
        }
      }
      .layoutWeight(1)
      .alignItems(HorizontalAlign.Start)

      // æ“ä½œæŒ‰é’®
      Column({ space: 8 }) {
        Button(config.isActive ? 'åœç”¨' : 'å¯ç”¨')
          .fontSize(12)
          .fontColor(config.isActive ? $r('app.color.danger_color') : $r('app.color.success_color'))
          .backgroundColor($r('app.color.page_background'))
          .height(32)
          .width(60)
          .onClick(() => {
            this.toggleConfigStatus(config);
          })

        Button('åˆ é™¤')
          .fontSize(12)
          .fontColor($r('app.color.danger_color'))
          .backgroundColor($r('app.color.page_background'))
          .height(32)
          .width(60)
          .onClick(() => {
            this.showDeleteConfirmDialog(config);
          })
      }
    }
    .width('100%')
    .padding(16)
    .backgroundColor($r('app.color.card_background'))
  }

  // åˆ‡æ¢é…ç½®çŠ¶æ€
  async toggleConfigStatus(config: RecurringBillConfig) {
    try {
      config.isActive = !config.isActive;
      await this.recurringDb.updateConfig(config);
      await this.loadConfigs();
      this.getUIContext().getPromptAction().showToast({
        message: config.isActive ? "å·²å¯ç”¨" : "å·²åœç”¨",
        duration: 1000
      });
    } catch (err) {
      console.error('æ›´æ–°é…ç½®çŠ¶æ€å¤±è´¥', JSON.stringify(err));
      this.getUIContext().getPromptAction().showToast({
        message: "æ“ä½œå¤±è´¥",
        duration: 1000
      });
    }
  }

  // æ˜¾ç¤ºåˆ é™¤ç¡®è®¤å¯¹è¯æ¡†
  showDeleteConfirmDialog(config: RecurringBillConfig) {
    this.getUIContext().showAlertDialog({
      title: 'ç¡®è®¤åˆ é™¤',
      message: `ç¡®å®šè¦åˆ é™¤è¿™ä¸ªå®šæœŸè®°è´¦é…ç½®å—ï¼Ÿ\n\næ˜¯å¦åŒæ—¶åˆ é™¤å…³è”çš„è‡ªåŠ¨ç”Ÿæˆè´¦å•ï¼Ÿ`,
      buttons: [
        {
          value: 'å–æ¶ˆ',
          fontColor: $r('app.color.text_primary'),
          action: () => {}
        },
        {
          value: 'ä»…åˆ é™¤é…ç½®',
          fontColor: $r('app.color.primary_color'),
          action: () => {
            this.deleteConfig(config, false);
          }
        },
        {
          value: 'åˆ é™¤é…ç½®å’Œè´¦å•',
          fontColor: $r('app.color.danger_color'),
          action: () => {
            this.deleteConfig(config, true);
          }
        }
      ]
    });
  }

  // åˆ é™¤é…ç½®
  async deleteConfig(config: RecurringBillConfig, deleteRelatedBills: boolean) {
    if (!config.id) {
      return;
    }

    try {
      const records = await this.recurringDb.queryRecordsByConfigId(config.id);
      
      // å¦‚æœéœ€è¦åˆ é™¤å…³è”è´¦å•
      if (deleteRelatedBills) {
        const billDb = BillDatabase.getInstance();
        
        // åˆ é™¤æ‰€æœ‰å…³è”çš„è´¦å•
        for (const record of records) {
          try {
            await billDb.deleteBill(record.billId);
          } catch (err) {
            console.error(`åˆ é™¤è´¦å•${record.billId}å¤±è´¥`, JSON.stringify(err));
          }
        }
      }
      
      // æ— è®ºæ˜¯å¦åˆ é™¤è´¦å•ï¼Œéƒ½è¦åˆ é™¤ç”Ÿæˆè®°å½•
      if (records.length > 0) {
        await this.recurringDb.deleteRecordsByConfigId(config.id);
      }
      
      // åˆ é™¤é…ç½®
      await this.recurringDb.deleteConfig(config.id);
      await this.loadConfigs();
      
      this.getUIContext().getPromptAction().showToast({
        message: deleteRelatedBills ? "é…ç½®å’Œè´¦å•å·²åˆ é™¤" : "é…ç½®å·²åˆ é™¤",
        duration: 1500
      });
    } catch (err) {
      console.error('åˆ é™¤é…ç½®å¤±è´¥', JSON.stringify(err));
      this.getUIContext().getPromptAction().showToast({
        message: "åˆ é™¤å¤±è´¥",
        duration: 1000
      });
    }
  }
}
