import { BillModel, BillType, DEFAULT_CATEGORIES } from '../models/BillModel';
import { BillDatabase } from '../database/BillDatabase';
import { BillStatisticsUtil } from '../utils/BillStatisticsUtil';
import { DateUtil } from '../utils/DateUtil';
import router from '@ohos.router';
import fs from '@ohos.file.fs';
import picker from '@ohos.file.picker';
import { BusinessError } from '@ohos.base';
import util from '@ohos.util';

/**
 * è´¦å•åˆ—è¡¨é¡µé¢
 */
@Entry
@Component
struct BillListPage {
    @State bills: BillModel[] = []; // è´¦å•åˆ—è¡¨
    @State selectedYear: string = DateUtil.getCurrentYear(); // é€‰ä¸­çš„å¹´ä»½
    @State selectedMonth: string = DateUtil.getCurrentMonth(); // é€‰ä¸­çš„æœˆä»½
    @State totalIncome: number = 0; // æ€»æ”¶å…¥
    @State totalExpense: number = 0; // æ€»æ”¯å‡º
    @State balance: number = 0; // ç»“ä½™
    @State showClearDialog: boolean = false; // æ˜¾ç¤ºæ¸…ç©ºè´¦å•å¼¹çª—
    @State clearStartDate: string = ''; // æ¸…ç©ºèµ·å§‹æ—¥æœŸ
    @State clearEndDate: string = ''; // æ¸…ç©ºç»“æŸæ—¥æœŸ
    @State showClearStartDatePicker: boolean = false; // æ˜¾ç¤ºæ¸…ç©ºèµ·å§‹æ—¥æœŸé€‰æ‹©å™¨
    @State showClearEndDatePicker: boolean = false; // æ˜¾ç¤ºæ¸…ç©ºç»“æŸæ—¥æœŸé€‰æ‹©å™¨

    private billDb: BillDatabase = BillDatabase.getInstance();

    aboutToAppear() {
        this.loadBills();
    }

    // é¡µé¢æ¯æ¬¡æ˜¾ç¤ºæ—¶åˆ·æ–°æ•°æ®
    onPageShow() {
        this.loadBills();
    }

    // åŠ è½½è´¦å•æ•°æ®
    async loadBills() {
        try {
            this.bills = await this.billDb.queryBillsByYearMonth(this.selectedYear, this.selectedMonth);
            this.calculateStatistics();
        } catch (err) {
            console.error('åŠ è½½è´¦å•å¤±è´¥', JSON.stringify(err));
        }
    }

    // è®¡ç®—ç»Ÿè®¡æ•°æ®
    calculateStatistics() {
        const stats = BillStatisticsUtil.calculateStatistics(this.bills);
        this.totalIncome = stats.totalIncome;
        this.totalExpense = stats.totalExpense;
        this.balance = stats.balance;
    }

    // èŽ·å–åˆ†ç±»å›¾æ ‡
    getCategoryIcon(categoryName: string): string {
        const category = DEFAULT_CATEGORIES.find(cat => cat.name === categoryName);
        return category ? category.icon : 'ðŸ“';
    }

    build() {
        Column() {
            // æ ‡é¢˜æ 
            this.buildTitleBar();

            // æ—¥æœŸé€‰æ‹©å™¨
            this.buildDateSelector();

            // ç»Ÿè®¡å¡ç‰‡
            this.buildStatisticsCard();

            // å¯¼å…¥å¯¼å‡ºæŒ‰é’®
            this.buildImportExportButtons();

            // è´¦å•åˆ—è¡¨ï¼ˆå·²æ”¯æŒæ»šåŠ¨ï¼‰
            this.buildBillList();

            // æ¸…ç©ºè´¦å•æŒ‰é’®
            this.buildClearButton();

            // æ·»åŠ æŒ‰é’®
            this.buildAddButton();

            // æ¸…ç©ºè´¦å•å¼¹çª—
            if (this.showClearDialog) {
                this.buildClearBillsDialog();
            }
        }
        .width('100%')
        .height('100%')
        .backgroundColor($r('app.color.page_background'))
        .alignItems(HorizontalAlign.Start)
    }

    @Builder
    buildTitleBar() {
        Row() {
            Text('è¿”å›ž')
                .fontSize(16)
                .fontColor($r('app.color.text_primary'))
                .onClick(() => {
                    router.back();
                })

            Text('è´¦å•åˆ—è¡¨')
                .fontSize(20)
                .fontWeight(FontWeight.Bold)
                .fontColor($r('app.color.text_primary'))
                .layoutWeight(1)
                .textAlign(TextAlign.Center)

            Text('ç»Ÿè®¡')
                .fontSize(16)
                .fontColor($r('app.color.primary_color'))
                .onClick(() => {
                    router.pushUrl({ url: 'pages/StatisticsPage' });
                })
        }
        .width('100%')
        .height(56)
        .padding({ left: 16, right: 16 })
        .backgroundColor($r('app.color.card_background'))
    }

    @Builder
    buildDateSelector() {
        Row() {
            Button('<')
                .fontSize(18)
                .fontColor($r('app.color.text_primary'))
                .backgroundColor($r('app.color.page_background'))
                .width(40)
                .height(40)
                .onClick(() => {
                    this.previousMonth();
                })

            Text(DateUtil.formatYearMonth(`${this.selectedYear}-${this.selectedMonth}`))
                .fontSize(18)
                .fontWeight(FontWeight.Medium)
                .fontColor($r('app.color.text_primary'))
                .layoutWeight(1)
                .textAlign(TextAlign.Center)

            Button('>')
                .fontSize(18)
                .fontColor($r('app.color.text_primary'))
                .backgroundColor($r('app.color.page_background'))
                .width(40)
                .height(40)
                .onClick(() => {
                    this.nextMonth();
                })
        }
        .width('100%')
        .padding(16)
        .backgroundColor($r('app.color.card_background'))
        .margin({ top: 1 })
    }

    @Builder
    buildStatisticsCard() {
        Column() {
            Row() {
                Column() {
                    Text('æ”¶å…¥')
                        .fontSize(14)
                        .fontColor($r('app.color.text_secondary'))
                    Text('Â¥' + BillStatisticsUtil.formatAmount(this.totalIncome))
                        .fontSize(20)
                        .fontWeight(FontWeight.Bold)
                        .fontColor($r('app.color.success_color'))
                        .margin({ top: 4 })
                }
                .layoutWeight(1)

                Column() {
                    Text('æ”¯å‡º')
                        .fontSize(14)
                        .fontColor($r('app.color.text_secondary'))
                    Text('Â¥' + BillStatisticsUtil.formatAmount(this.totalExpense))
                        .fontSize(20)
                        .fontWeight(FontWeight.Bold)
                        .fontColor($r('app.color.danger_color'))
                        .margin({ top: 4 })
                }
                .layoutWeight(1)

                Column() {
                    Text('ç»“ä½™')
                        .fontSize(14)
                        .fontColor($r('app.color.text_secondary'))
                    Text('Â¥' + BillStatisticsUtil.formatAmount(this.balance))
                        .fontSize(20)
                        .fontWeight(FontWeight.Bold)
                        .fontColor(this.balance >= 0 ? $r('app.color.text_primary') : $r('app.color.danger_color'))
                        .margin({ top: 4 })
                }
                .layoutWeight(1)
            }
            .width('100%')
        }
        .width('100%')
        .padding(16)
        .backgroundColor($r('app.color.card_background'))
        .margin({ top: 12 })
        .borderRadius(8)
    }

    @Builder
    buildImportExportButtons() {
        Row() {
            Button('ðŸ“¤ å¯¼å‡ºæ•°æ®')
                .fontSize(15)
                .fontColor('#FFFFFF')
                .backgroundColor($r('app.color.success_color'))
                .height(44)
                .layoutWeight(1)
                .onClick(() => {
                    this.exportData();
                })

            Blank()
                .width(12)

            Button('ðŸ“¥ å¯¼å…¥æ•°æ®')
                .fontSize(15)
                .fontColor('#FFFFFF')
                .backgroundColor($r('app.color.info_color'))
                .height(44)
                .layoutWeight(1)
                .onClick(() => {
                    this.importData();
                })
        }
        .width('100%')
        .padding({ left: 12, right: 12, top: 12 })
    }

    @Builder
    buildBillList() {
        List() {
            ForEach(this.bills, (bill: BillModel) => {
                ListItem() {
                    this.buildBillItem(bill);
                }
                .swipeAction({ end: this.buildDeleteButton(bill) })
            })
        }
        .width('100%')
        .layoutWeight(1)
        .margin({ top: 12 })
    }

    @Builder
    buildClearButton() {
        Button('ðŸ—‘ï¸ æ¸…ç©ºè´¦å•')
            .fontSize(15)
            .fontColor('#FFFFFF')
            .backgroundColor($r('app.color.danger_color'))
            .height(44)
            .width('100%')
            .margin({ left: 12, right: 12, top: 8, bottom: 8 })
            .onClick(() => {
                this.showClearBillsDialog();
            })
    }

    @Builder
    buildBillItem(bill: BillModel) {
        Row() {
            // åˆ†ç±»å›¾æ ‡
            Text(this.getCategoryIcon(bill.category))
                .fontSize(32)
                .margin({ right: 12 })

            Column() {
                Text(bill.category)
                    .fontSize(16)
                    .fontWeight(FontWeight.Medium)
                    .fontColor($r('app.color.text_primary'))

                Text(DateUtil.formatDateChinese(bill.date))
                    .fontSize(12)
                    .fontColor($r('app.color.text_tertiary'))
                    .margin({ top: 4 })

                if (bill.note) {
                    Text(bill.note)
                        .fontSize(12)
                        .fontColor($r('app.color.text_secondary'))
                        .margin({ top: 4 })
                        .maxLines(1)
                        .textOverflow({ overflow: TextOverflow.Ellipsis })
                }
            }
            .alignItems(HorizontalAlign.Start)
            .layoutWeight(1)

            Text((bill.type === BillType.INCOME ? '+' : '-') + 'Â¥' + BillStatisticsUtil.formatAmount(bill.amount))
                .fontSize(18)
                .fontWeight(FontWeight.Bold)
                .fontColor(bill.type === BillType.INCOME ? $r('app.color.success_color') : $r('app.color.danger_color'))
        }
        .width('100%')
        .padding(16)
        .backgroundColor($r('app.color.card_background'))
        .borderRadius(8)
        .margin({ left: 12, right: 12, bottom: 8 })
    }

    @Builder
    buildDeleteButton(bill: BillModel) {
        Button('åˆ é™¤')
            .fontSize(16)
            .fontColor('#FFFFFF')
            .backgroundColor($r('app.color.danger_color'))
            .height('100%')
            .onClick(() => {
                this.deleteBill(bill);
            })
    }

    @Builder
    buildAddButton() {
        Button('+')
            .fontSize(32)
            .fontColor('#FFFFFF')
            .backgroundColor($r('app.color.primary_color'))
            .width(56)
            .height(56)
            .borderRadius(28)
            .position({ x: '85%', y: '85%' })
            .onClick(() => {
                router.pushUrl({ url: 'pages/AddBillPage' });
            })
    }

    // ä¸Šä¸€ä¸ªæœˆ
    previousMonth() {
        let year = parseInt(this.selectedYear);
        let month = parseInt(this.selectedMonth);

        month--;
        if (month < 1) {
            month = 12;
            year--;
        }

        this.selectedYear = String(year);
        this.selectedMonth = String(month).padStart(2, '0');
        this.loadBills();
    }

    // ä¸‹ä¸€ä¸ªæœˆ
    nextMonth() {
        let year = parseInt(this.selectedYear);
        let month = parseInt(this.selectedMonth);

        month++;
        if (month > 12) {
            month = 1;
            year++;
        }

        this.selectedYear = String(year);
        this.selectedMonth = String(month).padStart(2, '0');
        this.loadBills();
    }

    // åˆ é™¤è´¦å•
    async deleteBill(bill: BillModel) {
        if (!bill.id) {
            return;
        }

        try {
            await this.billDb.deleteBill(bill.id);
            await this.loadBills();
        } catch (err) {
            console.error('åˆ é™¤è´¦å•å¤±è´¥', JSON.stringify(err));
        }
    }

    // å¯¼å‡ºæ•°æ®
    async exportData() {
        try {
            // æŸ¥è¯¢æ‰€æœ‰è´¦å•
            const allBills = await this.billDb.queryAllBills();

            if (allBills.length === 0) {
                this.getUIContext().showAlertDialog({
                    message: 'æ²¡æœ‰æ•°æ®å¯å¯¼å‡º',
                    confirm: {
                        value: 'ç¡®å®š', action: () => {
                        }
                    }
                });
                return;
            }

            // è½¬æ¢ä¸ºJSONå­—ç¬¦ä¸²
            const jsonData = JSON.stringify(allBills, null, 2);

            // ä½¿ç”¨æ–‡æ¡£é€‰æ‹©å™¨ä¿å­˜æ–‡ä»¶
            const documentSaveOptions = new picker.DocumentSaveOptions();
            documentSaveOptions.newFileNames = [`bills_backup_${DateUtil.formatDate(new Date())}.json`];
            const documentPicker = new picker.DocumentViewPicker();

            const uris = await documentPicker.save(documentSaveOptions);
            if (uris && uris.length > 0) {
                const file = fs.openSync(uris[0], fs.OpenMode.WRITE_ONLY | fs.OpenMode.CREATE | fs.OpenMode.TRUNC);
                // ä½¿ç”¨UTF-8ç¼–ç å†™å…¥,é¿å…ä¸­æ–‡ä¹±ç 
                const encoder = new util.TextEncoder();
                const uint8Array = encoder.encodeInto(jsonData);
                fs.writeSync(file.fd, uint8Array.buffer);
                fs.closeSync(file);

                this.getUIContext().showAlertDialog({
                    message: `æˆåŠŸå¯¼å‡º ${allBills.length} æ¡è´¦å•è®°å½•\n(åŒ…å«ä¸»é”®ID)`,
                    confirm: {
                        value: 'ç¡®å®š', action: () => {
                        }
                    }
                });
            }
        } catch (err) {
            console.error('å¯¼å‡ºæ•°æ®å¤±è´¥', JSON.stringify(err));
            this.getUIContext().showAlertDialog({
                message: 'å¯¼å‡ºå¤±è´¥: ' + (err as BusinessError).message,
                confirm: {
                    value: 'ç¡®å®š', action: () => {
                    }
                }
            });
        }
    }

    // å¯¼å…¥æ•°æ®
    async importData() {
        try {
            // ä½¿ç”¨æ–‡æ¡£é€‰æ‹©å™¨é€‰æ‹©æ–‡ä»¶
            const documentSelectOptions = new picker.DocumentSelectOptions();
            documentSelectOptions.maxSelectNumber = 1;
            const documentPicker = new picker.DocumentViewPicker();

            const uris = await documentPicker.select(documentSelectOptions);
            if (!uris || uris.length === 0) {
                return;
            }

            // è¯»å–æ–‡ä»¶å†…å®¹
            const file = fs.openSync(uris[0], fs.OpenMode.READ_ONLY);
            const buffer = new ArrayBuffer(10 * 1024 * 1024); // 10MB ç¼“å†²åŒº
            const readLen = fs.readSync(file.fd, buffer);
            fs.closeSync(file);

            // ä½¿ç”¨UTF-8è§£ç ,é¿å…ä¸­æ–‡ä¹±ç 
            const decoder = util.TextDecoder.create('utf-8');
            const jsonStr = decoder.decodeToString(new Uint8Array(buffer, 0, readLen));
            const bills: BillModel[] = JSON.parse(jsonStr);

            // ç¡®è®¤å¯¼å…¥
            this.getUIContext().showAlertDialog({
                message: `æ–‡ä»¶åŒ…å« ${bills.length} æ¡è´¦å•è®°å½•ï¼Œæ˜¯å¦å¯¼å…¥ï¼Ÿ\nä¸»é”®ç›¸åŒçš„è®°å½•å°†è¢«æ›´æ–°`,
                primaryButton:{
                    value: 'å¯¼å…¥',
                    fontColor: '#FF0000',
                    action: async () => {
                        await this.performImport(bills);
                    }
                },
                secondaryButton:{
                    value: 'å–æ¶ˆ',
                    action:() => {}
                },
                cancel: () => {
                }
            });
        } catch (err) {
            console.error('å¯¼å…¥æ•°æ®å¤±è´¥', JSON.stringify(err));
            this.getUIContext().showAlertDialog({
                message: 'å¯¼å…¥å¤±è´¥: ' + (err as BusinessError).message,
                confirm: {
                    value: 'ç¡®å®š', action: () => {
                    }
                }
            });
        }
    }

    // æ‰§è¡Œå¯¼å…¥
    async performImport(bills: BillModel[]) {
        try {
            let insertCount = 0;
            let updateCount = 0;
            let failCount = 0;

            for (const bill of bills) {
                try {
                    if (bill.id) {
                        // æ£€æŸ¥IDæ˜¯å¦å­˜åœ¨
                        const existingBill = await this.billDb.queryBillById(bill.id);
                        if (existingBill) {
                            // IDå­˜åœ¨,æ‰§è¡Œæ›´æ–°
                            await this.billDb.updateBill(bill);
                            updateCount++;
                        } else {
                            // IDä¸å­˜åœ¨,ç›´æŽ¥æ’å…¥(ä½¿ç”¨åŽŸID)
                            await this.billDb.insertBill(bill);
                            insertCount++;
                        }
                    } else {
                        // æ²¡æœ‰ID,æ’å…¥æ–°è®°å½•
                        await this.billDb.insertBill(bill);
                        insertCount++;
                    }
                } catch (err) {
                    console.error('å¯¼å…¥è´¦å•å¤±è´¥', JSON.stringify(err));
                    failCount++;
                }
            }

            await this.loadBills();

            this.getUIContext().showAlertDialog({
                message: `å¯¼å…¥å®Œæˆ\næ–°å¢ž: ${insertCount} æ¡\næ›´æ–°: ${updateCount} æ¡\nå¤±è´¥: ${failCount} æ¡`,
                confirm: {
                    value: 'ç¡®å®š', action: () => {
                    }
                }
            });
        } catch (err) {
            console.error('æ‰§è¡Œå¯¼å…¥å¤±è´¥', JSON.stringify(err));
            this.getUIContext().showAlertDialog({
                message: 'å¯¼å…¥è¿‡ç¨‹å‡ºé”™: ' + (err as BusinessError).message,
                confirm: {
                    value: 'ç¡®å®š', action: () => {
                    }
                }
            });
        }
    }

    // æ˜¾ç¤ºæ¸…ç©ºè´¦å•å¯¹è¯æ¡†
    showClearBillsDialog() {
        // åˆå§‹åŒ–é»˜è®¤æ—¥æœŸèŒƒå›´ï¼ˆå½“å‰æœˆä»½çš„ç¬¬ä¸€å¤©åˆ°æœ€åŽä¸€å¤©ï¼‰
        const year = parseInt(this.selectedYear);
        const month = parseInt(this.selectedMonth);
        this.clearStartDate = `${this.selectedYear}-${this.selectedMonth}-01`;
        
        // è®¡ç®—æœˆä»½æœ€åŽä¸€å¤©
        const lastDay = new Date(year, month, 0).getDate();
        this.clearEndDate = `${this.selectedYear}-${this.selectedMonth}-${String(lastDay).padStart(2, '0')}`;
        
        this.showClearDialog = true;
    }

    // æ¸…ç©ºè´¦å•å¼¹çª—
    @Builder
    buildClearBillsDialog() {
        Stack() {
            // é®ç½©å±‚
            Column()
                .width('100%')
                .height('100%')
                .backgroundColor('rgba(0, 0, 0, 0.5)')
                .onClick(() => {
                    this.showClearDialog = false;
                    this.showClearStartDatePicker = false;
                    this.showClearEndDatePicker = false;
                })

            // å¯¹è¯æ¡†å†…å®¹
            Column() {
                Text('æ¸…ç©ºè´¦å•')
                    .fontSize(18)
                    .fontWeight(FontWeight.Bold)
                    .fontColor($r('app.color.text_primary'))
                    .margin({ bottom: 20 })

                // èµ·å§‹æ—¥æœŸ
                Row() {
                    Text('èµ·å§‹æ—¥æœŸ:')
                        .fontSize(14)
                        .fontColor($r('app.color.text_primary'))
                        .width(80)

                    Text(this.clearStartDate)
                        .fontSize(14)
                        .fontColor(this.clearStartDate ? $r('app.color.primary_color') : $r('app.color.text_tertiary'))
                        .layoutWeight(1)
                        .onClick(() => {
                            this.showClearStartDatePickerDialog();
                        })
                }
                .width('100%')
                .margin({ bottom: 16 })

                // ç»“æŸæ—¥æœŸ
                Row() {
                    Text('ç»“æŸæ—¥æœŸ:')
                        .fontSize(14)
                        .fontColor($r('app.color.text_primary'))
                        .width(80)

                    Text(this.clearEndDate)
                        .fontSize(14)
                        .fontColor(this.clearEndDate ? $r('app.color.primary_color') : $r('app.color.text_tertiary'))
                        .layoutWeight(1)
                        .onClick(() => {
                            this.showClearEndDatePickerDialog();
                        })
                }
                .width('100%')
                .margin({ bottom: 20 })

                // æŒ‰é’®
                Row() {
                    Button('ç¡®è®¤æ¸…ç©º')
                        .fontSize(15)
                        .fontColor('#FFFFFF')
                        .backgroundColor($r('app.color.danger_color'))
                        .layoutWeight(1)
                        .onClick(() => {
                            this.confirmClearBills();
                        })

                    Blank()
                        .width(12)

                    Button('å–æ¶ˆ')
                        .fontSize(15)
                        .fontColor($r('app.color.text_primary'))
                        .backgroundColor($r('app.color.page_background'))
                        .layoutWeight(1)
                        .onClick(() => {
                            this.showClearDialog = false;
                        })
                }
                .width('100%')
            }
            .width('85%')
            .padding(20)
            .backgroundColor($r('app.color.card_background'))
            .borderRadius(12)

            // èµ·å§‹æ—¥æœŸé€‰æ‹©å™¨
            if (this.showClearStartDatePicker) {
                Column() {
                    DatePicker({
                        start: new Date('2000-01-01'),
                        selected: this.parseDateString(this.clearStartDate)
                    })
                        .onChange((value: DatePickerResult) => {
                            this.clearStartDate = this.formatDatePickerResult(value);
                            this.showClearStartDatePicker = false;
                        })

                    Button('å–æ¶ˆ')
                        .fontSize(14)
                        .margin({ top: 10 })
                        .onClick(() => {
                            this.showClearStartDatePicker = false;
                        })
                }
                .width('85%')
                .padding(20)
                .backgroundColor($r('app.color.card_background'))
                .borderRadius(12)
            }

            // ç»“æŸæ—¥æœŸé€‰æ‹©å™¨
            if (this.showClearEndDatePicker) {
                Column() {
                    DatePicker({
                        start: new Date('2000-01-01'),
                        selected: this.parseDateString(this.clearEndDate)
                    })
                        .onChange((value: DatePickerResult) => {
                            this.clearEndDate = this.formatDatePickerResult(value);
                            this.showClearEndDatePicker = false;
                        })

                    Button('å–æ¶ˆ')
                        .fontSize(14)
                        .margin({ top: 10 })
                        .onClick(() => {
                            this.showClearEndDatePicker = false;
                        })
                }
                .width('85%')
                .padding(20)
                .backgroundColor($r('app.color.card_background'))
                .borderRadius(12)
            }
        }
        .width('100%')
        .height('100%')
        .position({ x: 0, y: 0 })
        .zIndex(1000)
        .alignContent(Alignment.Center)
    }

    // æ˜¾ç¤ºèµ·å§‹æ—¥æœŸé€‰æ‹©å™¨
    showClearStartDatePickerDialog() {
        this.showClearStartDatePicker = true;
        this.showClearEndDatePicker = false;
    }

    // æ˜¾ç¤ºç»“æŸæ—¥æœŸé€‰æ‹©å™¨
    showClearEndDatePickerDialog() {
        this.showClearEndDatePicker = true;
        this.showClearStartDatePicker = false;
    }

    // è§£æžæ—¥æœŸå­—ç¬¦ä¸²ä¸ºDateå¯¹è±¡
    parseDateString(dateStr: string): Date {
        if (!dateStr) {
            return new Date();
        }
        const parts = dateStr.split('-');
        if (parts.length === 3) {
            return new Date(parseInt(parts[0]), parseInt(parts[1]) - 1, parseInt(parts[2]));
        }
        return new Date();
    }

    // æ ¼å¼åŒ–DatePickerç»“æžœä¸ºYYYY-MM-DD
    formatDatePickerResult(value: DatePickerResult): string {
        const year = value.year;
        const month = String((value.month ?? 0) + 1).padStart(2, '0');
        const day = String(value.day).padStart(2, '0');
        return `${year}-${month}-${day}`;
    }


    // ç¡®è®¤æ¸…ç©ºè´¦å•
    async confirmClearBills() {
        // éªŒè¯æ—¥æœŸèŒƒå›´
        if (this.clearStartDate > this.clearEndDate) {
            this.getUIContext().showAlertDialog({
                message: 'èµ·å§‹æ—¥æœŸä¸èƒ½å¤§äºŽç»“æŸæ—¥æœŸ',
                confirm: {
                    value: 'ç¡®å®š', action: () => {
                    }
                }
            });
            return;
        }

        try {
            // ä½¿ç”¨æ—¥æœŸèŒƒå›´æŸ¥è¯¢,æå‡æ€§èƒ½
            const billsToDelete = await this.billDb.queryBillsByDateRange(this.clearStartDate, this.clearEndDate);

            if (billsToDelete.length === 0) {
                this.getUIContext().showAlertDialog({
                    message: 'è¯¥æ—¥æœŸèŒƒå›´å†…æ²¡æœ‰è´¦å•è®°å½•',
                    confirm: {
                        value: 'ç¡®å®š', action: () => {
                            this.showClearDialog = false;
                        }
                    }
                });
                return;
            }

            // æ˜¾ç¤ºç¡®è®¤å¯¹è¯æ¡†
            this.getUIContext().showAlertDialog({
                message: `ç¡®å®šè¦åˆ é™¤ ${this.clearStartDate} è‡³ ${this.clearEndDate} æœŸé—´çš„ ${billsToDelete.length} æ¡è´¦å•è®°å½•å—ï¼Ÿ\n\næ­¤æ“ä½œä¸å¯æ¢å¤ï¼`,
                primaryButton: {
                    value: 'åˆ é™¤',
                    fontColor: '#FF0000',
                    action: async () => {
                        await this.performClearBills(billsToDelete);
                    }
                },
                secondaryButton: {
                    value: 'å–æ¶ˆ',
                    action: () => {
                    }
                }
            });
        } catch (err) {
            console.error('æŸ¥è¯¢è´¦å•å¤±è´¥', JSON.stringify(err));
            this.getUIContext().showAlertDialog({
                message: 'æŸ¥è¯¢è´¦å•å¤±è´¥: ' + (err as BusinessError).message,
                confirm: {
                    value: 'ç¡®å®š', action: () => {
                    }
                }
            });
        }
    }

    // æ‰§è¡Œæ¸…ç©ºè´¦å•
    async performClearBills(billsToDelete: BillModel[]) {
        try {
            let successCount = 0;
            let failCount = 0;

            for (const bill of billsToDelete) {
                if (bill.id) {
                    try {
                        await this.billDb.deleteBill(bill.id);
                        successCount++;
                    } catch (err) {
                        console.error('åˆ é™¤è´¦å•å¤±è´¥', JSON.stringify(err));
                        failCount++;
                    }
                }
            }

            this.showClearDialog = false;
            await this.loadBills();

            this.getUIContext().showAlertDialog({
                message: `æ¸…ç©ºå®Œæˆ\næˆåŠŸåˆ é™¤: ${successCount} æ¡\nå¤±è´¥: ${failCount} æ¡`,
                confirm: {
                    value: 'ç¡®å®š', action: () => {
                    }
                }
            });
        } catch (err) {
            console.error('æ¸…ç©ºè´¦å•å¤±è´¥', JSON.stringify(err));
            this.getUIContext().showAlertDialog({
                message: 'æ¸…ç©ºè´¦å•å¤±è´¥: ' + (err as BusinessError).message,
                confirm: {
                    value: 'ç¡®å®š', action: () => {
                    }
                }
            });
        }
    }
}
