import { BillModel, BillType, DEFAULT_CATEGORIES } from '../models/BillModel';
import { BillDatabase } from '../database/BillDatabase';
import { BillStatisticsUtil } from '../utils/BillStatisticsUtil';
import { DateUtil } from '../utils/DateUtil';
import router from '@ohos.router';

// åˆ†ç±»ç»Ÿè®¡é¡¹æ¥å£
interface CategoryStatItem {
    category: string;
    amount: number;
    percentage: string;
    type: BillType;
}

// è·¯ç”±å‚æ•°æ¥å£
interface RouteParams {
    category: string;
    year: string;
    month?: string;
}

/**
 * ç»Ÿè®¡é¡µé¢
 */
@Entry
@Component
struct StatisticsPage {
    @State bills: BillModel[] = []; // æ‰€æœ‰è´¦å•
    @State selectedYear: string = DateUtil.getCurrentYear(); // é€‰ä¸­çš„å¹´ä»½
    @State selectedMonth: string = DateUtil.getCurrentMonth(); // é€‰ä¸­çš„æœˆä»½
    @State categoryStats: CategoryStatItem[] = [];
    @State totalIncome: number = 0;
    @State totalExpense: number = 0;
    @State statisticsMode: 'month' | 'year' | 'all' = 'month'; // ç»Ÿè®¡æ¨¡å¼ï¼šæŒ‰æœˆã€æŒ‰å¹´æˆ–å…¨éƒ¨
    private billDb: BillDatabase = BillDatabase.getInstance();

    aboutToAppear() {
        this.loadStatistics();
    }

    // é¡µé¢æ¯æ¬¡æ˜¾ç¤ºæ—¶åˆ·æ–°æ•°æ®
    onPageShow() {
        this.loadStatistics();
    }

    // åŠ è½½ç»Ÿè®¡æ•°æ®
    async loadStatistics() {
        try {
            if (this.statisticsMode === 'month') {
                this.bills = await this.billDb.queryBillsByYearMonth(this.selectedYear, this.selectedMonth);
            } else if (this.statisticsMode === 'year') {
                this.bills = await this.billDb.queryBillsByYear(this.selectedYear);
            } else {
                // å…¨éƒ¨ç»Ÿè®¡
                this.bills = await this.billDb.queryAllBills();
            }
            this.calculateCategoryStatistics();
        } catch (err) {
            console.error('åŠ è½½ç»Ÿè®¡æ•°æ®å¤±è´¥', JSON.stringify(err));
        }
    }

    // è®¡ç®—åˆ†ç±»ç»Ÿè®¡
    calculateCategoryStatistics() {
        const stats = BillStatisticsUtil.calculateStatistics(this.bills);
        this.totalIncome = stats.totalIncome;
        this.totalExpense = stats.totalExpense;

        // æ„å»ºåˆ†ç±»ç»Ÿè®¡æ•°ç»„
        this.categoryStats = [];

        // æ”¯å‡ºåˆ†ç±»ç»Ÿè®¡
        const expenseCategories = DEFAULT_CATEGORIES.filter(cat => cat.type === BillType.EXPENSE);
        expenseCategories.forEach(cat => {
            const amount = stats.categoryStats.get(cat.name) || 0;
            if (amount > 0) {
                const statItem: CategoryStatItem = {
                    category: cat.name,
                    amount: amount,
                    percentage: BillStatisticsUtil.getCategoryPercentage(amount, this.totalExpense),
                    type: BillType.EXPENSE
                };
                this.categoryStats.push(statItem);
            }
        });

        // æ”¶å…¥åˆ†ç±»ç»Ÿè®¡
        const incomeCategories = DEFAULT_CATEGORIES.filter(cat => cat.type === BillType.INCOME);
        incomeCategories.forEach(cat => {
            const amount = stats.categoryStats.get(cat.name) || 0;
            if (amount > 0) {
                const statItem: CategoryStatItem = {
                    category: cat.name,
                    amount: amount,
                    percentage: BillStatisticsUtil.getCategoryPercentage(amount, this.totalIncome),
                    type: BillType.INCOME
                };
                this.categoryStats.push(statItem);
            }
        });

        // æŒ‰é‡‘é¢é™åºæ’åº
        this.categoryStats.sort((a, b) => b.amount - a.amount);
    }

    build() {
        Column() {
            // æ ‡é¢˜æ 
            this.buildTitleBar();

            // å¯æ»šåŠ¨å†…å®¹åŒºåŸŸ
            Scroll() {
                Column() {
                    // æ—¥æœŸé€‰æ‹©å™¨
                    this.buildDateSelector();

                    // æ€»è§ˆå¡ç‰‡
                    this.buildOverviewCard();

                    // åˆ†ç±»ç»Ÿè®¡åˆ—è¡¨
                    this.buildCategoryStatsList();
                }
                .width('100%')
                .alignItems(HorizontalAlign.Start)
            }
            .layoutWeight(1)
            .scrollBar(BarState.Auto)
            .scrollable(ScrollDirection.Vertical)
            .edgeEffect(EdgeEffect.Spring)
            .align(Alignment.Top)
        }
        .width('100%')
        .height('100%')
        .backgroundColor('#F5F5F5')
        .alignItems(HorizontalAlign.Start)
    }

    @Builder
    buildTitleBar() {
        Row() {
            Text('è¿”å›')
                .fontSize(16)
                .fontColor('#333333')
                .onClick(() => {
                    router.back();
                })

            Text('è´¦å•ç»Ÿè®¡')
                .fontSize(18)
                .fontWeight(FontWeight.Bold)
                .layoutWeight(1)
                .textAlign(TextAlign.Center)

            Text('   ')
                .fontSize(16)
        }
        .width('100%')
        .height(56)
        .padding({ left: 16, right: 16 })
        .backgroundColor('#FFFFFF')
    }

    @Builder
    buildDateSelector() {
        Column() {
            // æ¨¡å¼åˆ‡æ¢æŒ‰é’®
            Row() {
                Button(this.statisticsMode === 'month' ? 'æŒ‰æœˆ' : (this.statisticsMode === 'year' ? 'æŒ‰å¹´' : 'å…¨éƒ¨'))
                    .fontSize(14)
                    .fontColor('#007DFF')
                    .backgroundColor('#E6F2FF')
                    .height(32)
                    .onClick(() => {
                        if (this.statisticsMode === 'month') {
                            this.statisticsMode = 'year';
                        } else if (this.statisticsMode === 'year') {
                            this.statisticsMode = 'all';
                        } else {
                            this.statisticsMode = 'month';
                        }
                        this.loadStatistics();
                    })
            }
            .width('100%')
            .padding({
                left: 16,
                right: 16,
                top: 12,
                bottom: 8
            })
            .justifyContent(FlexAlign.End)

            // æ—¥æœŸé€‰æ‹©å™¨ (ä»…åœ¨æŒ‰æœˆæˆ–æŒ‰å¹´æ¨¡å¼ä¸‹æ˜¾ç¤º)
            if (this.statisticsMode !== 'all') {
                Row() {
                    Button('<')
                        .fontSize(18)
                        .fontColor('#333333')
                        .backgroundColor('#F0F0F0')
                        .width(40)
                        .height(40)
                        .onClick(() => {
                            if (this.statisticsMode === 'month') {
                                this.previousMonth();
                            } else {
                                this.previousYear();
                            }
                        })

                    Text(this.statisticsMode === 'month'
                        ? DateUtil.formatYearMonth(`${this.selectedYear}-${this.selectedMonth}`)
                        : `${this.selectedYear}å¹´`)
                        .fontSize(18)
                        .fontWeight(FontWeight.Medium)
                        .fontColor('#333333')
                        .layoutWeight(1)
                        .textAlign(TextAlign.Center)

                Button('>')
                    .fontSize(18)
                    .fontColor('#333333')
                    .backgroundColor('#F0F0F0')
                    .width(40)
                    .height(40)
                    .onClick(() => {
                        if (this.statisticsMode === 'month') {
                            this.nextMonth();
                        } else {
                            this.nextYear();
                        }
                    })
                }
                .width('100%')
                .padding({ left: 16, right: 16, bottom: 12 })
            } else {
                // å…¨éƒ¨ç»Ÿè®¡æ¨¡å¼ä¸‹æ˜¾ç¤ºæç¤ºæ–‡æœ¬
                Text('å…¨éƒ¨è´¦å•ç»Ÿè®¡')
                    .fontSize(18)
                    .fontWeight(FontWeight.Medium)
                    .fontColor('#333333')
                    .width('100%')
                    .textAlign(TextAlign.Center)
                    .padding(12)
            }
        }
        .width('100%')
        .backgroundColor('#FFFFFF')
        .margin({ top: 1 })
    }

    @Builder
    buildOverviewCard() {
        Column() {
            Row() {
                Column() {
                    Text('æ”¶å…¥')
                        .fontSize(14)
                        .fontColor('#666666')
                    Text('Â¥' + BillStatisticsUtil.formatAmount(this.totalIncome))
                        .fontSize(24)
                        .fontWeight(FontWeight.Bold)
                        .fontColor('#00B894')
                        .margin({ top: 8 })
                }
                .layoutWeight(1)

                Column() {
                    Text('æ”¯å‡º')
                        .fontSize(14)
                        .fontColor('#666666')
                    Text('Â¥' + BillStatisticsUtil.formatAmount(this.totalExpense))
                        .fontSize(24)
                        .fontWeight(FontWeight.Bold)
                        .fontColor('#FF6B6B')
                        .margin({ top: 8 })
                }
                .layoutWeight(1)
            }
            .width('100%')

            Divider()
                .margin({ top: 16, bottom: 16 })

            Row() {
                Text('ç»“ä½™')
                    .fontSize(14)
                    .fontColor('#666666')

                Blank()

                Text('Â¥' + BillStatisticsUtil.formatAmount(this.totalIncome - this.totalExpense))
                    .fontSize(24)
                    .fontWeight(FontWeight.Bold)
                    .fontColor((this.totalIncome - this.totalExpense) >= 0 ? '#00B894' : '#FF6B6B')
            }
            .width('100%')
        }
        .width('100%')
        .padding(16)
        .backgroundColor('#FFFFFF')
        .margin({ top: 12 })
        .borderRadius(8)
    }

    @Builder
    buildCategoryStatsList() {
        Column() {
            Text('åˆ†ç±»ç»Ÿè®¡')
                .fontSize(16)
                .fontWeight(FontWeight.Bold)
                .fontColor('#333333')
                .width('100%')
                .padding({ left: 16, top: 16, bottom: 8 })

            if (this.categoryStats.length === 0) {
                Text('æš‚æ— æ•°æ®')
                    .fontSize(14)
                    .fontColor('#999999')
                    .width('100%')
                    .textAlign(TextAlign.Center)
                    .padding(32)
            } else {
                Column() {
                    ForEach(this.categoryStats, (stat: CategoryStatItem) => {
                        this.buildCategoryItem(stat);
                    })
                }
                .width('100%')
            }
        }
        .width('100%')
        .margin({ top: 12 })
        .backgroundColor('#FFFFFF')
        .borderRadius(8)
    }

    @Builder
    buildCategoryItem(stat: CategoryStatItem) {
        Column() {
            Row() {
                // è·å–åˆ†ç±»å›¾æ ‡
                Text(this.getCategoryIcon(stat.category, stat.type))
                    .fontSize(24)
                    .margin({ right: 12 })

                Column() {
                    Text(stat.category)
                        .fontSize(16)
                        .fontWeight(FontWeight.Medium)
                        .fontColor('#333333')

                    Text(stat.percentage + '%')
                        .fontSize(12)
                        .fontColor('#999999')
                        .margin({ top: 4 })
                }
                .alignItems(HorizontalAlign.Start)
                .layoutWeight(1)

                Text('Â¥' + BillStatisticsUtil.formatAmount(stat.amount))
                    .fontSize(18)
                    .fontWeight(FontWeight.Bold)
                    .fontColor(stat.type === BillType.INCOME ? '#00B894' : '#FF6B6B')
            }
            .width('100%')
            .padding(16)

            // è¿›åº¦æ¡
            Row()
                .width(stat.percentage + '%')
                .height(4)
                .backgroundColor(stat.type === BillType.INCOME ? '#00B894' : '#FF6B6B')
                .borderRadius(2)

            Divider()
                .margin({ top: 8 })
        }
        .width('100%')
        .onClick(() => {
            // è·³è½¬åˆ°åˆ†ç±»è¯¦æƒ…
            let params: RouteParams = {
                category: stat.category,
                year: this.selectedYear
            };
            if (this.statisticsMode === 'month') {
                // æŒ‰æœˆç»Ÿè®¡æ—¶ä¼ é€’æœˆä»½å‚æ•°
                params.month = this.selectedMonth;
            } else if (this.statisticsMode === 'all') {
                // å…¨éƒ¨ç»Ÿè®¡æ—¶ä¸ä¼ é€’å¹´ä»½,é€šè¿‡yearä¸ºç©ºå­—ç¬¦ä¸²æ ‡è¯†
                params.year = '';
            }
            // æŒ‰å¹´ç»Ÿè®¡æ—¶åªä¼ é€’å¹´ä»½
            router.pushUrl({
                url: 'pages/CategoryDetailPage',
                params: params
            } as router.RouterOptions);
        })
    }

    // è·å–åˆ†ç±»å›¾æ ‡
    getCategoryIcon(categoryName: string, type: BillType): string {
        const category = DEFAULT_CATEGORIES.find(cat => cat.name === categoryName && cat.type === type);
        return category ? category.icon : 'ğŸ“';
    }

    // ä¸Šä¸€ä¸ªæœˆ
    previousMonth() {
        let year = parseInt(this.selectedYear);
        let month = parseInt(this.selectedMonth);

        month--;
        if (month < 1) {
            month = 12;
            year--;
        }

        this.selectedYear = String(year);
        this.selectedMonth = String(month).padStart(2, '0');
        this.loadStatistics();
    }

    // ä¸‹ä¸€ä¸ªæœˆ
    nextMonth() {
        let year = parseInt(this.selectedYear);
        let month = parseInt(this.selectedMonth);

        month++;
        if (month > 12) {
            month = 1;
            year++;
        }

        this.selectedYear = String(year);
        this.selectedMonth = String(month).padStart(2, '0');
        this.loadStatistics();
    }

    // ä¸Šä¸€å¹´
    previousYear() {
        let year = parseInt(this.selectedYear);
        year--;
        this.selectedYear = String(year);
        this.loadStatistics();
    }

    // ä¸‹ä¸€å¹´
    nextYear() {
        let year = parseInt(this.selectedYear);
        year++;
        this.selectedYear = String(year);
        this.loadStatistics();
    }
}
